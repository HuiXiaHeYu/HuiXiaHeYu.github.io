import{rendererRich as S,defaultTwoslashOptions as E,createTransformerFactory as F}from"@shikijs/twoslash/core";import{fromMarkdown as M}from"mdast-util-from-markdown";import{gfmFromMarkdown as V}from"mdast-util-gfm";import{toHast as I,defaultHandlers as b}from"mdast-util-to-hast";import q from"node:fs/promises";import y,{join as T}from"node:path";import w from"node:process";import{removeTwoslashNotations as D}from"twoslash";import{createTwoslasher as H}from"twoslash-vue";import{logger as k,hash as N}from"vuepress/utils";import{writeFileSync as J,existsSync as R,readFileSync as _,mkdirSync as A}from"node:fs";const C=e=>(e.type==="element"&&((e.properties??={})["v-pre"]=""),e),v=e=>[{type:"element",tagName:"span",properties:{},children:[e.token]},{type:"element",tagName:"template",properties:{"v-slot:popper":"{}"},content:{type:"root",children:[C(e.popup)]},children:[]}];function x(e){const t=M(e.replace(/\{@link ([^}]*)\}/g,"$1"),{mdastExtensions:[V()]});return I(t,{handlers:{code:(o,r)=>{const n=r,a=n.lang??"",{children:s}=this.codeToHast(n.value,{...this.options,transformers:[],lang:a,structure:n.value.trim().includes(`
`)?"classic":"inline"});return a?{type:"element",tagName:"div",properties:{class:`language-${a}`,"data-ext":a,"data-title":a,"data-highlighter":"shiki",style:s[0]?.type==="element"&&s[0].tagName==="pre"?s[0].properties.style:""},children:s}:b.code(o,r)}}}).children}function P(e,t){const o=t==="tag:param"?e.replace(/^([\w$-]+)/,"`$1` "):e,r=x.call(this,o);return r.length===1&&r[0].type==="element"&&r[0].tagName==="p"?r[0].children:r}const j=(e={})=>{const{errorRendering:t="line",floatingVue:o={}}=e,{classCopyIgnore:r="vp-copy-ignore",classFloatingPanel:n="twoslash-floating",classCode:a="vp-code",classMarkdown:s="",attrMarkdown:l="vp-content",floatingVueTheme:h="twoslash",floatingVueThemeQuery:u="twoslash-query",floatingVueThemeCompletion:f="twoslash-completion"}=o,d={class:"twoslash-hover","popper-class":["shiki",n,r,a].join(" "),theme:h};return S({classExtra:r,...e,renderMarkdown:x,renderMarkdownInline:P,hast:{hoverToken:{tagName:"v-menu",properties:d},hoverCompose:v,queryToken:{tagName:"v-menu",properties:{...d,":shown":"true",theme:u}},queryCompose:v,popupDocs:{class:`twoslash-popup-docs ${s}`,properties:{[l]:""}},popupDocsTags:{class:`twoslash-popup-docs twoslash-popup-docs-tags ${s}`,properties:{[l]:""}},popupError:{class:`twoslash-popup-error ${s}`,properties:{[l]:""}},errorToken:t==="line"?void 0:{tagName:"v-menu",properties:{...d,class:"twoslash-error twoslash-error-hover"}},errorCompose:v,completionCompose({popup:p,cursor:i}){return[{type:"element",tagName:"v-menu",properties:{"popper-class":["shiki twoslash-completion",r,n],theme:f,":shown":"true"},children:[i,{type:"element",tagName:"template",properties:{"v-slot:popper":"{}"},content:{type:"root",children:[C(p)]}}]}]}}})};async function O(){const e=y.join(w.cwd(),"tsconfig.json");try{const t=JSON.parse(await q.readFile(e,"utf-8")),o=t.compilerOptions?.baseUrl,r=t.compilerOptions?.paths??null;if(o&&r){const n=y.join(w.cwd(),o);for(const a in r){const s=r[a];r[a]=Array.isArray(s)?s.map(l=>y.resolve(n,l)):[y.resolve(n,s)]}}return r}catch{return null}}const U=async(e={})=>{const t=e.explicitTrigger??=!0,o=e.twoslashOptions??={},{compilerOptions:r={}}=o,n={...E(),...o,compilerOptions:{baseUrl:w.cwd(),...r,paths:{...r.paths,...await O()}}},a=e.throws??(w.env.CI||w.env.NODE_ENV==="production"),s=(p,i)=>{if(k.error(`

--------
Twoslash error in code:
--------
${i.split(/\n/g).slice(0,15).join(`
`).trim()}
--------
`),a)throw p;return k.error(p),D(i)},l=H(n),{typesCache:h}=e;let u=l;h&&(u=(p,i,c)=>{const g=h.read(p);if(g)return g;const m=l(p,i,c);return h.write(p,m),m},u.getCacheMap=l.getCacheMap,h.init?.());const f=F(u)({langs:["ts","tsx","js","jsx","json","vue"],renderer:j(e),onShikiError:s,onTwoslashError:s,...e,explicitTrigger:t,twoslashOptions:n}),d=t instanceof RegExp?t:/\btwoslash\b/;return{name:"vuepress:twoslash",...f,preprocess(p,i){const{transformers:c}=i;if(c){const g=c.findIndex(({name:m})=>m==="vuepress:clean-up");if(g>=0&&c.splice(g,1),!t||i.meta?.__raw?.match(d)){const m=c.findIndex(({name:$})=>$==="vuepress:v-pre");m>=0&&c.splice(m,1)}}return f.preprocess.call(this,p,i)},postprocess(p){return this.meta.twoslash?p.replace(/\{/g,"&#123;"):p}}},Q=({dir:e})=>({init(){A(e,{recursive:!0})},read(t){const o=N(t),r=T(e,`${o}.json`);return R(r)?JSON.parse(_(r,{encoding:"utf-8"})):null},write(t,o){const r=N(t),n=T(e,`${r}.json`),a=JSON.stringify(o);J(n,a,{encoding:"utf-8"})}});export{Q as createFileSystemTypesCache,U as createTwoslashTransformer,j as rendererFloatingVue,O as resolveTypeScriptPaths};
//# sourceMappingURL=index.js.map
